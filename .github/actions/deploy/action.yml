name: Deploy
description: Discover hosts from compose config and deploy via SSH

inputs:
  tag:
    description: Image tag to deploy
    required: true
  ssh-key:
    description: SSH private key for deploy user
    required: true
  command:
    description: Compose command (script/prod or script/dev)
    default: script/prod

runs:
  using: composite
  steps:
    - name: Setup SSH agent
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ inputs.ssh-key }}

    - name: Discover hosts
      id: discover
      shell: bash
      run: |
        hosts=$(${{ inputs.command }} config | PYTHONPATH=src python3 .github/actions/deploy/discover_hosts.py)
        echo "hosts=$hosts" >> "$GITHUB_OUTPUT"

    - name: Deploy to hosts
      shell: bash
      env:
        DEPLOY_TAG: ${{ inputs.tag }}
        HOSTS_JSON: ${{ steps.discover.outputs.hosts }}
      run: |
        echo "$HOSTS_JSON" | jq -c '.[]' | while read -r group; do
          host=$(echo "$group" | jq -r '.host')
          user=$(echo "$group" | jq -r '.user')
          dir=$(echo "$group" | jq -r '.dir')

          echo "::group::Deploy to $user@$host:$dir"
          ssh -o StrictHostKeyChecking=no "$user@$host" \
            "cd $dir && DEPLOY_TAG=$DEPLOY_TAG flow-deploy deploy"
          echo "::endgroup::"
        done
