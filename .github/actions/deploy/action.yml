name: Deploy
description: Discover hosts from compose config and deploy via SSH

inputs:
  tag:
    description: Image tag to deploy
    required: true
  ssh-key:
    description: SSH private key for deploy user
    required: true
  command:
    description: Compose command (script/prod or script/dev)
    default: script/prod
  host:
    description: Override deploy host (e.g. from vars.HOST_NAME)
    default: ""
  user:
    description: Override deploy user (e.g. from vars.HOST_USER)
    default: ""
  ssh-port:
    description: Override SSH port (e.g. from vars.SSH_PORT)
    default: ""
  registry-token:
    description: Token for GHCR authentication on deploy host
    default: ""

runs:
  using: composite
  steps:
    - name: Setup SSH agent
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ inputs.ssh-key }}

    - name: Discover hosts
      id: discover
      shell: bash
      env:
        HOST_NAME: ${{ inputs.host }}
        HOST_USER: ${{ inputs.user }}
      run: |
        touch .env
        hosts=$(${{ inputs.command }} config | PYTHONPATH=src python3 .github/actions/deploy/discover_hosts.py)
        echo "hosts=$hosts" >> "$GITHUB_OUTPUT"

    - name: Deploy to hosts
      shell: bash
      env:
        DEPLOY_TAG: ${{ inputs.tag }}
        HOSTS_JSON: ${{ steps.discover.outputs.hosts }}
        SSH_PORT: ${{ inputs.ssh-port }}
        REGISTRY_TOKEN: ${{ inputs.registry-token }}
      run: |
        port_args=()
        if [ -n "$SSH_PORT" ]; then
          port_args=(-p "$SSH_PORT")
        fi

        echo "$HOSTS_JSON" | jq -c '.[]' | while read -r group; do
          host=$(echo "$group" | jq -r '.host')
          user=$(echo "$group" | jq -r '.user')
          dir=$(echo "$group" | jq -r '.dir')

          echo "::group::Deploy to $user@$host:$dir"

          if [ -n "$REGISTRY_TOKEN" ]; then
            echo "$REGISTRY_TOKEN" | ssh -o StrictHostKeyChecking=no "${port_args[@]}" "$user@$host" \
              "docker login ghcr.io -u ${{ github.actor }} --password-stdin 2>/dev/null"
          fi

          ssh -o StrictHostKeyChecking=no "${port_args[@]}" "$user@$host" \
            "cd $dir && git pull --ff-only || { echo 'Deploy aborted: could not fast-forward. Check for local changes or diverged history on the server.'; exit 1; } && flow-deploy deploy --tag $DEPLOY_TAG"

          if [ -n "$REGISTRY_TOKEN" ]; then
            ssh -o StrictHostKeyChecking=no "${port_args[@]}" "$user@$host" \
              "docker logout ghcr.io 2>/dev/null"
          fi
          echo "::endgroup::"
        done
