#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

echo "Building flow-deploy binaries (musl + glibc)..."

docker build \
    -f "$PROJECT_DIR/Dockerfile.build" \
    -t flow-deploy-builder \
    "$PROJECT_DIR"

CONTAINER_ID=$(docker create flow-deploy-builder)
mkdir -p "$PROJECT_DIR/dist"
docker cp "$CONTAINER_ID:/dist/flow-deploy-linux-musl" "$PROJECT_DIR/dist/"
docker cp "$CONTAINER_ID:/dist/flow-deploy-linux-glibc" "$PROJECT_DIR/dist/"
docker rm "$CONTAINER_ID" > /dev/null

chmod +x "$PROJECT_DIR/dist/flow-deploy-linux-musl"
chmod +x "$PROJECT_DIR/dist/flow-deploy-linux-glibc"

echo "Binaries built:"
echo "  musl:  dist/flow-deploy-linux-musl  ($(du -h "$PROJECT_DIR/dist/flow-deploy-linux-musl" | cut -f1))"
echo "  glibc: dist/flow-deploy-linux-glibc ($(du -h "$PROJECT_DIR/dist/flow-deploy-linux-glibc" | cut -f1))"
