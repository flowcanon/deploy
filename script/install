#!/bin/sh
set -eu

REPO="flowcanon/deploy"
INSTALL_DIR="${INSTALL_DIR:-$HOME/.local/bin}"
BINARY_NAME="flow-deploy"

# Detect libc
detect_libc() {
    if ldd /bin/ls 2>&1 | grep -qi musl; then
        echo "musl"
    else
        echo "glibc"
    fi
}

LIBC=$(detect_libc)
URL="https://github.com/${REPO}/releases/latest/download/flow-deploy-linux-${LIBC}"

mkdir -p "$INSTALL_DIR"

echo "Detected libc: ${LIBC}"
echo "Downloading flow-deploy from ${URL}..."

if command -v curl >/dev/null 2>&1; then
    curl -fsSL -o "${INSTALL_DIR}/${BINARY_NAME}" "${URL}"
elif command -v wget >/dev/null 2>&1; then
    wget -qO "${INSTALL_DIR}/${BINARY_NAME}" "${URL}"
else
    echo "Error: curl or wget required" >&2
    exit 1
fi

chmod +x "${INSTALL_DIR}/${BINARY_NAME}"
echo "Installed: ${INSTALL_DIR}/${BINARY_NAME}"

case ":$PATH:" in
    *":${INSTALL_DIR}:"*) ;;
    *) echo "Note: ${INSTALL_DIR} is not in your current PATH. Start a new login shell or add it to your PATH." ;;
esac
